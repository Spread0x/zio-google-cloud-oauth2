<html><head><title>zio-google-cloud-oauth2: Web server</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Josip Grgurica" /><meta name="description" content="zio-google-cloud-oauth2" /><meta name="og:image" content="/zio-google-cloud-oauth2/img/poster.png" /><meta name="image" property="og:image" content="/zio-google-cloud-oauth2/img/poster.png" /><meta name="og:title" content="zio-google-cloud-oauth2: Web server" /><meta name="title" property="og:title" content="zio-google-cloud-oauth2: Web server" /><meta name="og:site_name" content="zio-google-cloud-oauth2" /><meta name="og:url" content="https://github.com/jkobejs/zio-google-cloud-oauth2" /><meta name="og:type" content="website" /><meta name="og:description" content="zio-google-cloud-oauth2" /><link rel="icon" type="image/png" href="/zio-google-cloud-oauth2/img/favicon.png" /><meta name="twitter:title" content="zio-google-cloud-oauth2: Web server" /><meta name="twitter:image" content="/zio-google-cloud-oauth2/img/poster.png" /><meta name="twitter:description" content="zio-google-cloud-oauth2" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@jkobejs" /><link rel="icon" type="image/png" sizes="16x16" href="/zio-google-cloud-oauth2/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/zio-google-cloud-oauth2/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/zio-google-cloud-oauth2/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/zio-google-cloud-oauth2/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/zio-google-cloud-oauth2/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/zio-google-cloud-oauth2/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/zio-google-cloud-oauth2/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/zio-google-cloud-oauth2/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/zio-google-cloud-oauth2/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/zio-google-cloud-oauth2/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/zio-google-cloud-oauth2/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/zio-google-cloud-oauth2/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/zio-google-cloud-oauth2/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/zio-google-cloud-oauth2/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/zio-google-cloud-oauth2/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/zio-google-cloud-oauth2/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/zio-google-cloud-oauth2/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/zio-google-cloud-oauth2/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/zio-google-cloud-oauth2/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/zio-google-cloud-oauth2/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/zio-google-cloud-oauth2/highlight/styles/vs.css" /><link rel="stylesheet" href="/zio-google-cloud-oauth2/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/zio-google-cloud-oauth2/" class="brand"><div class="brand-wrapper"></div><span>zio-google-cloud-oauth2</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/zio-google-cloud-oauth2/server-2-server/index.html" title="Server to server" class="">Server to server</a></div> <div class="sidebar-nav-item active "><a href="/zio-google-cloud-oauth2/web-server/index.html" title="Web server" class="active">Web server</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/jkobejs/zio-google-cloud-oauth2" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/jkobejs/zio-google-cloud-oauth2" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="jkobejs" data-github-repo="zio-google-cloud-oauth2"><div class="content-wrapper"><section><h2 id="oauth-20-server-side-web-apps">OAuth 2.0 Server-side Web Apps</h2>

<p><img src="webflow.png" alt="web-server" /></p>

<p>OAuth 2.0 allows users to share specific data with an application while keeping their usernames, passwords, and other information private. For example, an application can use OAuth 2.0 to obtain permission from users to store files in their Google Drives</p>

<p>This OAuth 2.0 flow is specifically for user authorization. It is designed for applications that can store confidential information and maintain state. A properly authorized web server application can access an API while the user interacts with the application or after the user has left the application.</p>

<h3 id="usage">Usage</h3>
<ul>
  <li><a href="#oauth-20-server-side-web-apps">OAuth 2.0 Server-side Web Apps</a>
    <ul>
      <li><a href="#usage">Usage</a>
        <ul>
          <li><a href="#create-service-account">Create service account</a></li>
        </ul>
      </li>
      <li><a href="#prerequisites">Prerequisites</a>
        <ul>
          <li><a href="#enable-apis-for-your-project">Enable APIs for your project</a></li>
          <li><a href="#create-authorization-credentials">Create authorization credentials</a></li>
        </ul>
      </li>
      <li><a href="#using-the-library">Using the library</a>
        <ul>
          <li><a href="#read-oauth-20-client-key-optional">Read OAuth 2.0 Client key (optional)</a></li>
          <li><a href="#authorize">Authorize</a></li>
          <li><a href="#authenticate">Authenticate</a></li>
          <li><a href="#refresh-an-access-token-offline-access">Refresh an access token (offline access)</a>
            <ul>
              <li><a href="#caching">Caching</a></li>
              <li><a href="#modularity">Modularity</a></li>
              <li><a href="#default">Default</a></li>
            </ul>
          </li>
          <li><a href="#integration-tests">Integration tests</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="create-service-account">Create service account</h4>
<p>To support server-to-server interactions, first create a [service account][service-account] for your project in the Google API Console.
A service account’s credentials include a generated email address that is unique and at least 
one public/private key pair.
If domain-wide delegation is enabled, then a client ID is also part of the service account’s credentials.</p>

<h3 id="prerequisites">Prerequisites</h3>

<h4 id="enable-apis-for-your-project">Enable APIs for your project</h4>

<p>Any application that calls Google APIs needs to enable those APIs in the API Console. To enable the appropriate APIs for your project:</p>

<ol>
  <li>Open the <a href="https://console.developers.google.com/apis/library">Library</a> page in the API Console.</li>
  <li>Select the project associated with your application. Create a project if you do not have one already.</li>
  <li>Use the Library page to find each API that your application will use. Click on each API and enable it for your project.</li>
</ol>

<h4 id="create-authorization-credentials">Create authorization credentials</h4>

<p>Any application that uses OAuth 2.0 to access Google APIs must have authorization credentials that identify the application to Google’s OAuth 2.0 server. The following steps explain how to create credentials for your project. Your applications can then use the credentials to access APIs that you have enabled for that project.</p>

<ol>
  <li>Open the <a href="https://console.developers.google.com/apis/credentials">Credentials page</a> in the API Console.</li>
  <li>Click <strong>Create credentials &gt; OAuth client ID</strong>.</li>
  <li>Complete the form. Set the application type to Web application. You must specify authorized redirect URIs. The redirect URIs are the endpoints to which the OAuth 2.0 server can send responses.</li>
</ol>

<p>It is best that you <a href="https://developers.google.com/identity/protocols/OAuth2WebServer#protectauthcode">design your app’s auth endpoints</a> so that your application does not expose authorization codes to other resources on the page.</p>

<p>After creating your credentials, download the <code class="highlighter-rouge">client_secret.json</code> file from the API Console. Securely store the file in a location that only your application can access.</p>

<blockquote>
  <p><strong>Important:</strong> Do not store the <code class="highlighter-rouge">client_secret.json</code> file in a publicly-accessible location. In addition, if you share the source code to your application — for example, on GitHub — store the <code class="highlighter-rouge">client_secret.json</code> file outside of your source tree to avoid inadvertently sharing your client credentials.</p>
</blockquote>

<h3 id="using-the-library">Using the library</h3>

<h4 id="read-oauth-20-client-key-optional">Read OAuth 2.0 Client key (optional)</h4>
<p>This step is optional. OAuth Client key, token URI, etc. can be provided in multiple ways (env vars, config, etc..).
This lib offers API to read client key (<code class="highlighter-rouge">client_secret.json</code>) JSON data from file system.</p>

<p>Client key reader provides default implementation which uses FS2 streams in trait <code class="highlighter-rouge">FS2OAuthClientKeyReader</code>. 
Since it reads file from filesystem, it requires blocking execution context which is provided by extending <code class="highlighter-rouge">zio.blocking.Blocking.Live</code> module.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">oAuthClientKeyReader</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">OAuthClientKeyReader</span>, <span class="kt">OAuthClientKeyError</span>, <span class="kt">OAuthClientKey</span><span class="o">]</span> <span class="k">=</span> <span class="nc">OAuthClientKeyReader</span><span class="o">.&gt;.</span><span class="py">readKey</span><span class="o">(</span><span class="s">"/path/to/client_secret.json"</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">oAuthClientKey</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">OAuthClientKeyError</span>, <span class="kt">OAuthClientKey</span><span class="o">]</span> <span class="k">=</span> <span class="nv">oAuthClientKeyReader</span><span class="o">.</span><span class="py">provide</span><span class="o">(</span><span class="k">new</span> <span class="nc">FS2OAuthClientKeyReader</span> <span class="k">with</span> <span class="nv">Blocking</span><span class="o">.</span><span class="py">Live</span> <span class="o">{})</span>
</code></pre></div></div>

<h4 id="authorize">Authorize</h4>

<p>To request for an access token, you must have authorization code which is obtained by providing to user an authorization URI which will ask for his consent.
The OAuth 2.0 server responds to your application’s access request by using the URL specified in the request (<code class="highlighter-rouge">redirect_uri</code>).</p>

<p>If the user approves the access request, then the response contains an authorization code. If the user does not approve the request, the response contains an error message. The authorization code or error message that is returned to the web server appears on the query string, as shown below:</p>

<p>An error response:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://oauth2.example.com/auth?error=access_denied
</code></pre></div></div>

<p>An authorization code response:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://oauth2.example.com/auth?code=4/P7q7W91a-oMsCeLvIaQm6bTrgtp7
</code></pre></div></div>

<p>The lib user is responsible for handling this URL callback and parsing the code/error from the request’s query param.</p>

<p>You generate this authorization URL with the following method:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">createAuthUrl</span><span class="o">(</span><span class="n">authApiConfig</span><span class="k">:</span> <span class="kt">AuthApiConfig</span><span class="o">,</span> <span class="n">authRequestParams</span><span class="k">:</span> <span class="kt">AuthRequestParams</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span>
</code></pre></div></div>

<p>It receives two parameters, <code class="highlighter-rouge">AuthApiConfig</code> and <code class="highlighter-rouge">AuthRequestParams</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Represents config used to connect to Google OAuth 2.0 server.
 *
 * @param clientId Google OAuth 2.0 Client ID
 * @param projectId Google project ID
 * @param authUri url used for creating authorization requests (obtaining authorization code)
 * @param tokenUri url used for creating authentication requests (obtaining access and refresh tokens)
 * @param clientSecret Google client password
 * @param redirectUris List of redirect URIs, must be verified in Google Console
 */</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">AuthApiConfig</span><span class="o">(</span>
  <span class="n">clientId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">projectId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">authUri</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">tokenUri</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">clientSecret</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">redirectUris</span><span class="k">:</span> <span class="kt">NonEmptyList</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
<span class="o">)</span>

<span class="cm">/**
 * Authentication request parameters. Used to construct [[AuthRequest]]
 *
 * @param scope A space-delimited list of scopes that identify the resources that your application could access on the user's behalf
 * @param redirectUri  Determines where the API server redirects the user after the user completes the authorization flow
 * @param accessType Indicates whether your application can refresh access tokens when the user is not present at the browser (online or offline)
 * @param state Specifies any string value that your application uses to maintain state between your authorization request and the authorization server's response. The server returns the exact value that you send as a name=value pair in the hash (#) fragment of the redirect_uri after the user consents to or denies your application's access request
 * @param includeGrantedScopes Enables applications to use incremental authorization to request access to additional scopes in context
 * @param loginHint The server uses the hint to simplify the login flow either by prefilling the email field in the sign-in form or by selecting the appropriate multi-login session
 * @param prompt A space-delimited, case-sensitive list of prompts to present the user. If you don't specify this parameter, the user will be prompted only the first time your app requests access. Possible values are: none, consent, select_account
 * @param responseType Response type - should be set to "code" for this type of requests
 */</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">AuthRequestParams</span><span class="o">(</span>
  <span class="n">scope</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">redirectUri</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
  <span class="n">accessType</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"offline"</span><span class="o">,</span>
  <span class="n">state</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
  <span class="n">includeGrantedScopes</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
  <span class="n">loginHint</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
  <span class="n">prompt</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"consent"</span><span class="o">),</span>
  <span class="n">responseType</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"code"</span>
<span class="o">)</span>
</code></pre></div></div>

<h4 id="authenticate">Authenticate</h4>
<p>Web server authentication is exposed in <code class="highlighter-rouge">Authenticator</code> module through service method</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">authenticate</span><span class="o">(</span><span class="n">authApiConfig</span><span class="k">:</span> <span class="kt">AuthApiConfig</span><span class="o">,</span> <span class="n">authorizationCode</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">AuthenticationError</span>, <span class="kt">AccessResponse</span><span class="o">]</span>
</code></pre></div></div>

<p>It receives two parameters, <code class="highlighter-rouge">AuthApiConfig</code> and <code class="highlighter-rouge">authorizationCode</code> (obtained from the <a href="#authorize">previous</a> step).</p>

<p>On success, <code class="highlighter-rouge">authentication</code> method returns:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Represents Authorization Server authentication response, having both access and refresh token.
 *
 * Access token expires in one hour and can be reused until it expires.
 * @param accessToken google access token
 * @param tokenType token type
 * @param expiresAt when will token expire
 * @param refreshToken google refresh token
 */</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">AccessResponse</span><span class="o">(</span>
  <span class="n">accessToken</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">tokenType</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">expiresAt</span><span class="k">:</span> <span class="kt">Instant</span><span class="o">,</span>
  <span class="n">refreshToken</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">)</span>
</code></pre></div></div>

<p>Module contains live implementation in <code class="highlighter-rouge">Authenticator.Live</code> that depends only on <code class="highlighter-rouge">org.http4s.client.Client</code> which is needed to make http requests.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">authenticatorLiveManaged</span><span class="k">:</span> <span class="kt">ZManaged</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Throwable</span>, <span class="kt">Authenticator</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ZIO</span>
  <span class="o">.</span><span class="py">runtime</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span>
  <span class="o">.</span><span class="py">toManaged_</span>
  <span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">rts</span> <span class="k">=&gt;</span>
    <span class="nc">BlazeClientBuilder</span><span class="o">[</span><span class="kt">Task</span><span class="o">](</span><span class="nv">rts</span><span class="o">.</span><span class="py">platform</span><span class="o">.</span><span class="py">executor</span><span class="o">.</span><span class="py">asEC</span><span class="o">)</span>
      <span class="o">.</span><span class="py">resource</span>
      <span class="o">.</span><span class="py">toManaged</span>
      <span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="nv">Authenticator</span><span class="o">.</span><span class="py">Live</span><span class="o">.</span><span class="py">apply</span><span class="o">)</span>
  <span class="o">}</span>

<span class="k">val</span> <span class="nv">accessResponse</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Throwable</span>, <span class="kt">AccessResponse</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Authenticator</span><span class="o">.&gt;.</span><span class="py">authenticate</span><span class="o">(</span><span class="n">authApiConfig</span><span class="o">,</span> <span class="n">authorizationCode</span><span class="o">).</span><span class="py">provideManaged</span><span class="o">(</span><span class="n">authenticatorLiveManaged</span><span class="o">)</span>
</code></pre></div></div>

<h4 id="refresh-an-access-token-offline-access">Refresh an access token (offline access)</h4>

<p>Web server access token refresh is exposed in <code class="highlighter-rouge">Authenticator</code> module through service method:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">refreshToken</span><span class="o">(</span><span class="n">authApiConfig</span><span class="k">:</span> <span class="kt">AuthApiConfig</span><span class="o">,</span> <span class="n">refreshToken</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">AuthenticationError</span>, <span class="kt">RefreshResponse</span><span class="o">]</span>
</code></pre></div></div>

<p>It receives two parameters, <code class="highlighter-rouge">AuthApiConfig</code> and <code class="highlighter-rouge">refreshToken</code> obtained from the <code class="highlighter-rouge">AccessResponse</code>.</p>

<p>On success, <code class="highlighter-rouge">refreshToken</code> method returns <code class="highlighter-rouge">RefreshResponse</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Response from refresh token request.
 *
 * @param accessToken google access token
 * @param tokenType token type
 * @param expiresAt when will token expire
 */</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RefreshResponse</span><span class="o">(</span>
  <span class="n">accessToken</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">tokenType</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">expiresAt</span><span class="k">:</span> <span class="kt">Instant</span>
<span class="o">)</span>
</code></pre></div></div>

<p>Access tokens periodically expire. You can refresh an access token without prompting the user for permission (including when the user is not present) if you requested offline access to the scopes associated with the token (default with this library).
Refresh token does not expire so it is advisable to persist it to database/file system so you can use it to access a Google API when the user is not present.</p>

<p>To refresh the access token, you can use the same <code class="highlighter-rouge">Authenticator.Live</code> managed resource as above:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">refreshResponse</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Throwable</span>, <span class="kt">RefreshResponse</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Authenticator</span><span class="o">.&gt;.</span><span class="py">refreshToken</span><span class="o">(</span><span class="n">authApiConfig</span><span class="o">,</span> <span class="nv">accessResponseVal</span><span class="o">.</span><span class="py">refreshToken</span><span class="o">).</span><span class="py">provideManaged</span><span class="o">(</span><span class="n">authenticatorLiveManaged</span><span class="o">)</span>
</code></pre></div></div>

<h6 id="caching">Caching</h6>
<p>Even though <a href="https://developers.google.com/identity/protocols/OAuth2WebServer">OAuth 2.0 for Web Server Applications</a> says that access tokens expire after one hour, authenticator doesn’t cache auth responses by itself.
It is left for user to decide how to keep tokens and when to <a href="#refresh-an-access-token-offline-access">refresh</a> them.
Since authenticator returns authentication responses wrapped in ZIO effect, it is easy to cache them by using builtin API:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">cached</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Authenticator</span> <span class="kt">with</span> <span class="kt">clock.Clock</span>, <span class="kt">Nothing</span>, <span class="kt">IO</span><span class="o">[</span><span class="kt">AuthenticationError</span>, <span class="kt">AccessResponse</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Authenticator</span><span class="o">.&gt;.</span><span class="py">authenticate</span><span class="o">(</span><span class="n">authApiConfig</span><span class="o">,</span> <span class="n">authorizationCode</span><span class="o">).</span><span class="py">cached</span><span class="o">(</span><span class="nv">duration</span><span class="o">.</span><span class="py">Duration</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nv">TimeUnit</span><span class="o">.</span><span class="py">HOURS</span><span class="o">))</span>
</code></pre></div></div>

<h6 id="modularity">Modularity</h6>
<p>Web server API is modular and exposes these ZIO modules, <a href="https://github.com/jkobejs/zio-google-cloud-oauth2/blob/master/src/main/scala/io/github/jkobejs/zio/google/cloud/oauth2/webserver/authenticator/Authenticator.scala">Authenticator</a> and <a href="https://github.com/jkobejs/zio-google-cloud-oauth2/blob/master/src/main/scala/io/github/jkobejs/zio/google/cloud/oauth2/webserver/http/HttpClient.scala">HttpClient</a>.
With this approach users can easily switch between their own implementations or the ones that library offers.</p>

<p>If for example user sees value in using different http client, all that is necessary is to implement</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">authenticate</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HttpAccessRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">HttpError</span>, <span class="kt">HttpAccessResponse</span><span class="o">]</span>

<span class="k">def</span> <span class="nf">refreshToken</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HttpRefreshRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">HttpError</span>, <span class="kt">HttpRefreshResponse</span><span class="o">]</span>
</code></pre></div></div>
<p>methods in <code class="highlighter-rouge">HttpClient.Service[R]</code> service.</p>

<p>Method <code class="highlighter-rouge">authenticate</code> receives parameter of type <code class="highlighter-rouge">HttpAuthRequest</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">HttpAccessRequest</span><span class="o">(</span><span class="n">uri</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">httpAccessRequestBody</span><span class="k">:</span> <span class="kt">HttpAccessRequestBody</span><span class="o">)</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">HttpAccessRequestBody</span><span class="o">(</span>
  <span class="n">code</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">redirect_uri</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">client_id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">client_secret</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">grant_type</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"authorization_code"</span>
<span class="o">)</span>
</code></pre></div></div>

<p>On success it returns <code class="highlighter-rouge">HttpAccessResponse</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">HttpAccessResponse</span><span class="o">(</span>
  <span class="n">access_token</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">token_type</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">expires_in</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
  <span class="n">refresh_token</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">)</span>
</code></pre></div></div>
<p>Method <code class="highlighter-rouge">refreshToken</code> receives parameter of type <code class="highlighter-rouge">HttpRefreshRequest</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">HttpRefreshRequest</span><span class="o">(</span><span class="n">uri</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">httpRefreshRequestBody</span><span class="k">:</span> <span class="kt">HttpRefreshRequestBody</span><span class="o">)</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">HttpRefreshRequestBody</span><span class="o">(</span>
  <span class="n">refresh_token</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">client_id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">client_secret</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">grant_type</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"refresh_token"</span>
<span class="o">)</span>
</code></pre></div></div>

<p>On success it returns <code class="highlighter-rouge">HttpRefreshResponse</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">HttpRefreshResponse</span><span class="o">(</span>
  <span class="n">access_token</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">token_type</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">expires_in</span><span class="k">:</span> <span class="kt">Long</span>
<span class="o">)</span>
</code></pre></div></div>

<h6 id="default">Default</h6>
<p>Authenticator module offers default implementation in trait <code class="highlighter-rouge">Authenticator.Default</code> which depends on</p>
<ul>
  <li>HttpClient</li>
  <li>zio.clock.Clock</li>
</ul>

<p>services.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Default</span> <span class="k">extends</span> <span class="nc">Authenticator</span> <span class="o">{</span>
  <span class="n">self</span> <span class="k">=&gt;</span>
  <span class="k">val</span> <span class="nv">httpClient</span><span class="k">:</span> <span class="kt">HttpClient.Service</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span>
  <span class="k">val</span> <span class="nv">clock</span><span class="k">:</span> <span class="kt">Clock.Service</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Authenticator live implementation <code class="highlighter-rouge">Authenticator.Live</code> extends <code class="highlighter-rouge">Default</code> implementation and uses these modules:</p>
<ul>
  <li><code class="highlighter-rouge">Http4sClient</code> implementation of <code class="highlighter-rouge">HttpClient</code> module</li>
  <li><code class="highlighter-rouge">Clock.Live</code> implementation of <code class="highlighter-rouge">Clock</code> module</li>
</ul>

<p>To use <code class="highlighter-rouge">Authenticator.Live</code> implementation user needs to provide instance of <code class="highlighter-rouge">org.http4s.client.Client</code>.</p>

<h4 id="integration-tests">Integration tests</h4>
<p>To run integration tests together with unit tests you need to export path to client key JSON file in 
<code class="highlighter-rouge">OAUTH_CLIENT_KEY_PATH</code> env variable.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OAUTH_CLIENT_KEY_PATH</span><span class="o">=</span>/.../client_secret.json

sbt <span class="nb">test</span>
</code></pre></div></div>
<p>If <code class="highlighter-rouge">OAUTH_CLIENT_KEY_PATH</code> env variable is provided with valid client key file, the integration test will open the browser where you’ll need to consent to using the app.
After consent, Google auth server will send authorization code to redirect URI that you provided in <a href="#prerequisites">prerequisites</a> step.
When testing, integration test expects that URI to be <code class="highlighter-rouge">http://localhost:8080</code> so it can continue with authentication and refresh token request tests.</p>

</section></div></div></div></div><script src="/zio-google-cloud-oauth2/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
              </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'jkobejs/zio-google-cloud-oauth2'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/zio-google-cloud-oauth2/js/docs.js"></script></body></html>