<html><head><title>zio-google-cloud-oauth2: Server to server</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Josip Grgurica" /><meta name="description" content="zio-google-cloud-oauth2" /><meta name="og:image" content="/zio-google-cloud-oauth2/img/poster.png" /><meta name="image" property="og:image" content="/zio-google-cloud-oauth2/img/poster.png" /><meta name="og:title" content="zio-google-cloud-oauth2: Server to server" /><meta name="title" property="og:title" content="zio-google-cloud-oauth2: Server to server" /><meta name="og:site_name" content="zio-google-cloud-oauth2" /><meta name="og:url" content="https://github.com/jkobejs/zio-goolge-cloud-oauth2" /><meta name="og:type" content="website" /><meta name="og:description" content="zio-google-cloud-oauth2" /><link rel="icon" type="image/png" href="/zio-google-cloud-oauth2/img/favicon.png" /><meta name="twitter:title" content="zio-google-cloud-oauth2: Server to server" /><meta name="twitter:image" content="/zio-google-cloud-oauth2/img/poster.png" /><meta name="twitter:description" content="zio-google-cloud-oauth2" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@jkobejs" /><link rel="icon" type="image/png" sizes="16x16" href="/zio-google-cloud-oauth2/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/zio-google-cloud-oauth2/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/zio-google-cloud-oauth2/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/zio-google-cloud-oauth2/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/zio-google-cloud-oauth2/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/zio-google-cloud-oauth2/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/zio-google-cloud-oauth2/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/zio-google-cloud-oauth2/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/zio-google-cloud-oauth2/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/zio-google-cloud-oauth2/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/zio-google-cloud-oauth2/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/zio-google-cloud-oauth2/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/zio-google-cloud-oauth2/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/zio-google-cloud-oauth2/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/zio-google-cloud-oauth2/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/zio-google-cloud-oauth2/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/zio-google-cloud-oauth2/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/zio-google-cloud-oauth2/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/zio-google-cloud-oauth2/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/zio-google-cloud-oauth2/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/zio-google-cloud-oauth2/highlight/styles/vs.css" /><link rel="stylesheet" href="/zio-google-cloud-oauth2/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/zio-google-cloud-oauth2/" class="brand"><div class="brand-wrapper"></div><span>zio-google-cloud-oauth2</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item active "><a href="/zio-google-cloud-oauth2/server-2-server/index.html" title="Server to server" class="active">Server to server</a></div> <div class="sidebar-nav-item  "><a href="/zio-google-cloud-oauth2/service-account-key-reader/index.html" title="Service account key reader" class="">Service account key reader</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/jkobejs/zio-google-cloud-oauth2" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/jkobejs/zio-google-cloud-oauth2" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="jkobejs" data-github-repo="zio-google-cloud-oauth2"><div class="content-wrapper"><section><h2 id="server-to-server">Server to server</h2>

<p>To support server-to-server interactions, first create a service account for your project in the Google API Console.</p>

<p>Server to server interaction is modular and exposes these zio modules, <a href="https://github.com/jkobejs/zio-google-cloud-oauth2/blob/master/src/main/scala/io/github/jkobejs/zio/google/cloud/oauth2/server2server/authenticator/Authenticator.scala">Authenticator</a>, 
<a href="https://github.com/jkobejs/zio-google-cloud-oauth2/blob/master/src/main/scala/io/github/jkobejs/zio/google/cloud/oauth2/server2server/sign/JwtSign.scala">JwtSign</a> and <a href="https://github.com/jkobejs/zio-google-cloud-oauth2/blob/master/src/main/scala/io/github/jkobejs/zio/google/cloud/oauth2/server2server/http/HttpClient.scala">HttpClient</a>.</p>

<p><code class="highlighter-rouge">Authenticator</code> is main module and it exposes service with auth method which receives cloud api config and cloud api 
claims and returns <code class="highlighter-rouge">AuthResponse</code> with access token inside zio effect which is parametrized with <code class="highlighter-rouge">AuthenticatorError</code>
error type.</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">authResponse</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">AuthenticatorError</span>, <span class="kt">AuthResponse</span><span class="o">]</span>
</code></pre></div></div>

<h3 id="default">Default</h3>
<p>Authenticator module offers default implementation in trait <code class="highlighter-rouge">Authenticator.Default</code> which depends on</p>
<ul>
  <li>JwtSign</li>
  <li>HttpClient</li>
  <li>zio.clock.Clock</li>
</ul>

<p>services.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Default</span> <span class="k">extends</span> <span class="nc">Authenticator</span> <span class="o">{</span>
  <span class="n">self</span> <span class="k">=&gt;</span>
  <span class="k">val</span> <span class="nv">jwtSign</span><span class="k">:</span> <span class="kt">JwtSign.Service</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span>
  <span class="k">val</span> <span class="nv">httpClient</span><span class="k">:</span> <span class="kt">HttpClient.Service</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span>
  <span class="k">val</span> <span class="nv">clock</span><span class="k">:</span> <span class="kt">Clock.Service</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span>

  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="live">Live</h3>

<p>Authenticator module also offers live implementation of <code class="highlighter-rouge">Default</code> trait in trait <code class="highlighter-rouge">Authenticator.Live</code> 
which injects:</p>
<ul>
  <li><code class="highlighter-rouge">TsetJwtSign</code> implementation of <code class="highlighter-rouge">JwtSign</code> module</li>
  <li><code class="highlighter-rouge">Http4sClient</code> implementation of <code class="highlighter-rouge">HttpClient</code> module</li>
  <li><code class="highlighter-rouge">Clock.Live</code> implementation of <code class="highlighter-rouge">Clock</code> module</li>
</ul>

<p>To use <code class="highlighter-rouge">Authenticator.Live</code> implementation user needs to provide instance of <code class="highlighter-rouge">org.http4s.client.Client</code>.</p>

<h3 id="modularity">Modularity</h3>
<p>Server to server api is extremely modular and with this approach users can easily switch between their own 
implementations or the ones that library offers. If for example user sees value in using different http client 
all that is necessary is to implement</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">auth</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HttpAuthRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">HttpError</span>, <span class="kt">HttpAuthResponse</span><span class="o">]</span>
</code></pre></div></div>
<p>method in <code class="highlighter-rouge">HttpClient.Service[Any]</code> and inject it in <code class="highlighter-rouge">Authenticator.Default</code> implementation. The same is for <code class="highlighter-rouge">JtwSign</code> service.</p>

<h3 id="caching">Caching</h3>
<p>Even though <a href="https://developers.google.com/identity/protocols/OAuth2ServiceAccount">Google Cloud server to server</a> says that access tokens expire after one hour
authenticator doesn’t cache auth responses by itself, it is left for user to decide. Since authenticator returns
auth responses wrapped in zio effect it is easy to cache them by using builtin API:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">cached</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Authenticator</span> <span class="kt">with</span> <span class="kt">clock.Clock</span>, <span class="kt">Nothing</span>, <span class="kt">IO</span><span class="o">[</span><span class="kt">AuthenticatorError</span>, <span class="kt">AuthResponse</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Authenticator</span><span class="o">.&gt;.</span><span class="py">auth</span><span class="o">(</span><span class="n">apiConfig</span><span class="o">,</span> <span class="n">apiClaims</span><span class="o">).</span><span class="py">cached</span><span class="o">(</span><span class="nv">duration</span><span class="o">.</span><span class="py">Duration</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nv">TimeUnit</span><span class="o">.</span><span class="py">HOURS</span><span class="o">))</span>
</code></pre></div></div>

<h3 id="live-example">Live example</h3>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">serviceAccountKeyReader</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">ServiceAccountKeyReader</span>, <span class="kt">ServiceAccountKeyError</span>, <span class="kt">ServiceAccountKey</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ServiceAccountKeyReader</span><span class="o">.&gt;.</span><span class="py">readKey</span><span class="o">(</span><span class="s">"path-to-service-account-key"</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">authenticatorLiveManaged</span><span class="k">:</span> <span class="kt">ZManaged</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Throwable</span>, <span class="kt">Authenticator.Live</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ZIO</span>
  <span class="o">.</span><span class="py">runtime</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span>
  <span class="o">.</span><span class="py">toManaged_</span>
  <span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">rts</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="nv">exec</span> <span class="k">=</span> <span class="nv">rts</span><span class="o">.</span><span class="py">platform</span><span class="o">.</span><span class="py">executor</span><span class="o">.</span><span class="py">asEC</span>
    <span class="nc">BlazeClientBuilder</span><span class="o">[</span><span class="kt">Task</span><span class="o">](</span><span class="n">exec</span><span class="o">)</span>
      <span class="o">.</span><span class="py">resource</span>
      <span class="o">.</span><span class="py">toManaged</span>
      <span class="o">.</span><span class="py">map</span><span class="o">(</span>
        <span class="n">client4s</span> <span class="k">=&gt;</span>
          <span class="k">new</span> <span class="nv">Authenticator</span><span class="o">.</span><span class="py">Live</span> <span class="o">{</span>
            <span class="k">val</span> <span class="nv">client</span><span class="k">:</span> <span class="kt">Client</span><span class="o">[</span><span class="kt">zio.Task</span><span class="o">]</span> <span class="k">=</span> <span class="n">client4s</span>
          <span class="o">}</span>
      <span class="o">)</span>
  <span class="o">}</span> 

<span class="k">val</span> <span class="nv">authResponse</span><span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Throwable</span>, <span class="kt">AuthResponse</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">serviceAccountKey</span> <span class="k">&lt;-</span> <span class="nv">serviceAccountKeyReader</span><span class="o">.</span><span class="py">provide</span><span class="o">(</span><span class="k">new</span> <span class="nc">FS2ServiceAccountKeyReader</span> <span class="k">with</span> <span class="nv">Blocking</span><span class="o">.</span><span class="py">Live</span> <span class="o">{})</span>
  <span class="n">cloudApiConfig</span>    <span class="k">=</span> <span class="nc">CloudApiConfig</span><span class="o">(</span>
    <span class="n">uri</span>        <span class="k">=</span> <span class="nv">serviceAccountKey</span><span class="o">.</span><span class="py">token_uri</span><span class="o">,</span>
    <span class="n">privateKey</span> <span class="k">=</span> <span class="nv">serviceAccountKey</span><span class="o">.</span><span class="py">private_key</span><span class="o">,</span>
    <span class="n">grantType</span>  <span class="k">=</span> <span class="s">"urn:ietf:params:oauth:grant-type:jwt-bearer"</span>
  <span class="o">)</span>
  <span class="n">cloudApiClaims</span>    <span class="k">=</span> <span class="nc">CloudApiClaims</span><span class="o">(</span>
    <span class="n">issuer</span>   <span class="k">=</span> <span class="nv">serviceAccountKey</span><span class="o">.</span><span class="py">client_email</span><span class="o">,</span>
    <span class="n">scope</span>    <span class="k">=</span> <span class="s">"https://www.googleapis.com/auth/devstorage.read_write"</span><span class="o">,</span>
    <span class="n">audience</span> <span class="k">=</span> <span class="nv">serviceAccountKey</span><span class="o">.</span><span class="py">token_uri</span>
  <span class="o">)</span>
  <span class="n">authResponse</span>     <span class="k">&lt;-</span> <span class="nc">Authenticator</span><span class="o">.&gt;.</span><span class="py">auth</span><span class="o">(</span><span class="n">cloudApiConfig</span><span class="o">,</span> <span class="n">cloudApiClaims</span><span class="o">).</span><span class="py">provideManaged</span><span class="o">(</span><span class="n">authenticatorLiveManaged</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">authResponse</span>
</code></pre></div></div>

</section></div></div></div></div><script src="/zio-google-cloud-oauth2/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
              </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'jkobejs/zio-google-cloud-oauth2'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/zio-google-cloud-oauth2/js/docs.js"></script></body></html>